import { PluginOption } from "vite";
import { NormalizedInputOptions, OutputChunk } from "rollup";
import { CodeAPI, CodeData } from "./api";

const errorWrap = (name: string) => "\"use strict\";var de=Object.defineProperty;var pe=(o,e,r)=>e in o?de(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r;var q=(o,e,r)=>(pe(o,typeof e!=\"symbol\"?e+\"\":e,r),r);Object.defineProperty(exports,Symbol.toStringTag,{value:\"Module\"});var oe={},Q={},X={},te=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\".split(\"\");X.encode=function(o){if(0<=o&&o<te.length)return te[o];throw new TypeError(\"Must be between 0 and 63: \"+o)};X.decode=function(o){var e=65,r=90,n=97,t=122,i=48,l=57,h=43,s=47,c=26,f=52;return e<=o&&o<=r?o-e:n<=o&&o<=t?o-n+c:i<=o&&o<=l?o-i+f:o==h?62:o==s?63:-1};var ie=X,Y=5,se=1<<Y,ue=se-1,le=se;function ve(o){return o<0?(-o<<1)+1:(o<<1)+0}function _e(o){var e=(o&1)===1,r=o>>1;return e?-r:r}Q.encode=function(e){var r=\"\",n,t=ve(e);do n=t&ue,t>>>=Y,t>0&&(n|=le),r+=ie.encode(n);while(t>0);return r};Q.decode=function(e,r,n){var t=e.length,i=0,l=0,h,s;do{if(r>=t)throw new Error(\"Expected more digits in base 64 VLQ value.\");if(s=ie.decode(e.charCodeAt(r++)),s===-1)throw new Error(\"Invalid base64 digit: \"+e.charAt(r-1));h=!!(s&le),s&=ue,i=i+(s<<l),l+=Y}while(h);n.value=_e(i),n.rest=r};var D={};(function(o){function e(u,a,v){if(a in u)return u[a];if(arguments.length===3)return v;throw new Error('\"'+a+'\" is a required argument.')}o.getArg=e;var r=/^(?:([\\w+\\-.]+):)?\\/\\/(?:(\\w+:\\w+)@)?([\\w.-]*)(?::(\\d+))?(.*)$/,n=/^data:.+\\,.+$/;function t(u){var a=u.match(r);return a?{scheme:a[1],auth:a[2],host:a[3],port:a[4],path:a[5]}:null}o.urlParse=t;function i(u){var a=\"\";return u.scheme&&(a+=u.scheme+\":\"),a+=\"//\",u.auth&&(a+=u.auth+\"@\"),u.host&&(a+=u.host),u.port&&(a+=\":\"+u.port),u.path&&(a+=u.path),a}o.urlGenerate=i;function l(u){var a=u,v=t(u);if(v){if(!v.path)return u;a=v.path}for(var d=o.isAbsolute(a),A=a.split(/\\/+/),k,P=0,T=A.length-1;T>=0;T--)k=A[T],k===\".\"?A.splice(T,1):k===\"..\"?P++:P>0&&(k===\"\"?(A.splice(T+1,P),P=0):(A.splice(T,2),P--));return a=A.join(\"/\"),a===\"\"&&(a=d?\"/\":\".\"),v?(v.path=a,i(v)):a}o.normalize=l;function h(u,a){u===\"\"&&(u=\".\"),a===\"\"&&(a=\".\");var v=t(a),d=t(u);if(d&&(u=d.path||\"/\"),v&&!v.scheme)return d&&(v.scheme=d.scheme),i(v);if(v||a.match(n))return a;if(d&&!d.host&&!d.path)return d.host=a,i(d);var A=a.charAt(0)===\"/\"?a:l(u.replace(/\\/+$/,\"\")+\"/\"+a);return d?(d.path=A,i(d)):A}o.join=h,o.isAbsolute=function(u){return u.charAt(0)===\"/\"||r.test(u)};function s(u,a){u===\"\"&&(u=\".\"),u=u.replace(/\\/$/,\"\");for(var v=0;a.indexOf(u+\"/\")!==0;){var d=u.lastIndexOf(\"/\");if(d<0||(u=u.slice(0,d),u.match(/^([^\\/]+:\\/)?\\/*$/)))return a;++v}return Array(v+1).join(\"../\")+a.substr(u.length+1)}o.relative=s;var c=function(){var u=Object.create(null);return!(\"__proto__\"in u)}();function f(u){return u}function _(u){return m(u)?\"$\"+u:u}o.toSetString=c?f:_;function p(u){return m(u)?u.slice(1):u}o.fromSetString=c?f:p;function m(u){if(!u)return!1;var a=u.length;if(a<9||u.charCodeAt(a-1)!==95||u.charCodeAt(a-2)!==95||u.charCodeAt(a-3)!==111||u.charCodeAt(a-4)!==116||u.charCodeAt(a-5)!==111||u.charCodeAt(a-6)!==114||u.charCodeAt(a-7)!==112||u.charCodeAt(a-8)!==95||u.charCodeAt(a-9)!==95)return!1;for(var v=a-10;v>=0;v--)if(u.charCodeAt(v)!==36)return!1;return!0}function w(u,a,v){var d=b(u.source,a.source);return d!==0||(d=u.originalLine-a.originalLine,d!==0)||(d=u.originalColumn-a.originalColumn,d!==0||v)||(d=u.generatedColumn-a.generatedColumn,d!==0)||(d=u.generatedLine-a.generatedLine,d!==0)?d:b(u.name,a.name)}o.compareByOriginalPositions=w;function M(u,a,v){var d=u.generatedLine-a.generatedLine;return d!==0||(d=u.generatedColumn-a.generatedColumn,d!==0||v)||(d=b(u.source,a.source),d!==0)||(d=u.originalLine-a.originalLine,d!==0)||(d=u.originalColumn-a.originalColumn,d!==0)?d:b(u.name,a.name)}o.compareByGeneratedPositionsDeflated=M;function b(u,a){return u===a?0:u===null?1:a===null?-1:u>a?1:-1}function C(u,a){var v=u.generatedLine-a.generatedLine;return v!==0||(v=u.generatedColumn-a.generatedColumn,v!==0)||(v=b(u.source,a.source),v!==0)||(v=u.originalLine-a.originalLine,v!==0)||(v=u.originalColumn-a.originalColumn,v!==0)?v:b(u.name,a.name)}o.compareByGeneratedPositionsInflated=C;function N(u){return JSON.parse(u.replace(/^\\)]}'[^\\n]*\\n/,\"\"))}o.parseSourceMapInput=N;function U(u,a,v){if(a=a||\"\",u&&(u[u.length-1]!==\"/\"&&a[0]!==\"/\"&&(u+=\"/\"),a=u+a),v){var d=t(v);if(!d)throw new Error(\"sourceMapURL could not be parsed\");if(d.path){var A=d.path.lastIndexOf(\"/\");A>=0&&(d.path=d.path.substring(0,A+1))}a=h(i(d),a)}return l(a)}o.computeSourceURL=U})(D);var H={},ee=D,re=Object.prototype.hasOwnProperty,I=typeof Map!=\"undefined\";function G(){this._array=[],this._set=I?new Map:Object.create(null)}G.fromArray=function(e,r){for(var n=new G,t=0,i=e.length;t<i;t++)n.add(e[t],r);return n};G.prototype.size=function(){return I?this._set.size:Object.getOwnPropertyNames(this._set).length};G.prototype.add=function(e,r){var n=I?e:ee.toSetString(e),t=I?this.has(e):re.call(this._set,n),i=this._array.length;(!t||r)&&this._array.push(e),t||(I?this._set.set(e,i):this._set[n]=i)};G.prototype.has=function(e){if(I)return this._set.has(e);var r=ee.toSetString(e);return re.call(this._set,r)};G.prototype.indexOf=function(e){if(I){var r=this._set.get(e);if(r>=0)return r}else{var n=ee.toSetString(e);if(re.call(this._set,n))return this._set[n]}throw new Error('\"'+e+'\" is not in the set.')};G.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error(\"No element indexed by \"+e)};G.prototype.toArray=function(){return this._array.slice()};H.ArraySet=G;var ae={},ce=D;function me(o,e){var r=o.generatedLine,n=e.generatedLine,t=o.generatedColumn,i=e.generatedColumn;return n>r||n==r&&i>=t||ce.compareByGeneratedPositionsInflated(o,e)<=0}function V(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}V.prototype.unsortedForEach=function(e,r){this._array.forEach(e,r)};V.prototype.add=function(e){me(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))};V.prototype.toArray=function(){return this._sorted||(this._array.sort(ce.compareByGeneratedPositionsInflated),this._sorted=!0),this._array};ae.MappingList=V;var B=Q,y=D,x=H.ArraySet,Se=ae.MappingList;function E(o){o||(o={}),this._file=y.getArg(o,\"file\",null),this._sourceRoot=y.getArg(o,\"sourceRoot\",null),this._skipValidation=y.getArg(o,\"skipValidation\",!1),this._sources=new x,this._names=new x,this._mappings=new Se,this._sourcesContents=null}E.prototype._version=3;E.fromSourceMap=function(e){var r=e.sourceRoot,n=new E({file:e.file,sourceRoot:r});return e.eachMapping(function(t){var i={generated:{line:t.generatedLine,column:t.generatedColumn}};t.source!=null&&(i.source=t.source,r!=null&&(i.source=y.relative(r,i.source)),i.original={line:t.originalLine,column:t.originalColumn},t.name!=null&&(i.name=t.name)),n.addMapping(i)}),e.sources.forEach(function(t){var i=t;r!==null&&(i=y.relative(r,t)),n._sources.has(i)||n._sources.add(i);var l=e.sourceContentFor(t);l!=null&&n.setSourceContent(t,l)}),n};E.prototype.addMapping=function(e){var r=y.getArg(e,\"generated\"),n=y.getArg(e,\"original\",null),t=y.getArg(e,\"source\",null),i=y.getArg(e,\"name\",null);this._skipValidation||this._validateMapping(r,n,t,i),t!=null&&(t=String(t),this._sources.has(t)||this._sources.add(t)),i!=null&&(i=String(i),this._names.has(i)||this._names.add(i)),this._mappings.add({generatedLine:r.line,generatedColumn:r.column,originalLine:n!=null&&n.line,originalColumn:n!=null&&n.column,source:t,name:i})};E.prototype.setSourceContent=function(e,r){var n=e;this._sourceRoot!=null&&(n=y.relative(this._sourceRoot,n)),r!=null?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[y.toSetString(n)]=r):this._sourcesContents&&(delete this._sourcesContents[y.toSetString(n)],Object.keys(this._sourcesContents).length===0&&(this._sourcesContents=null))};E.prototype.applySourceMap=function(e,r,n){var t=r;if(r==null){if(e.file==null)throw new Error(`SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map's \"file\" property. Both were omitted.`);t=e.file}var i=this._sourceRoot;i!=null&&(t=y.relative(i,t));var l=new x,h=new x;this._mappings.unsortedForEach(function(s){if(s.source===t&&s.originalLine!=null){var c=e.originalPositionFor({line:s.originalLine,column:s.originalColumn});c.source!=null&&(s.source=c.source,n!=null&&(s.source=y.join(n,s.source)),i!=null&&(s.source=y.relative(i,s.source)),s.originalLine=c.line,s.originalColumn=c.column,c.name!=null&&(s.name=c.name))}var f=s.source;f!=null&&!l.has(f)&&l.add(f);var _=s.name;_!=null&&!h.has(_)&&h.add(_)},this),this._sources=l,this._names=h,e.sources.forEach(function(s){var c=e.sourceContentFor(s);c!=null&&(n!=null&&(s=y.join(n,s)),i!=null&&(s=y.relative(i,s)),this.setSourceContent(s,c))},this)};E.prototype._validateMapping=function(e,r,n,t){if(r&&typeof r.line!=\"number\"&&typeof r.column!=\"number\")throw new Error(\"original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.\");if(!(e&&\"line\"in e&&\"column\"in e&&e.line>0&&e.column>=0&&!r&&!n&&!t)){if(e&&\"line\"in e&&\"column\"in e&&r&&\"line\"in r&&\"column\"in r&&e.line>0&&e.column>=0&&r.line>0&&r.column>=0&&n)return;throw new Error(\"Invalid mapping: \"+JSON.stringify({generated:e,source:n,original:r,name:t}))}};E.prototype._serializeMappings=function(){for(var e=0,r=1,n=0,t=0,i=0,l=0,h=\"\",s,c,f,_,p=this._mappings.toArray(),m=0,w=p.length;m<w;m++){if(c=p[m],s=\"\",c.generatedLine!==r)for(e=0;c.generatedLine!==r;)s+=\";\",r++;else if(m>0){if(!y.compareByGeneratedPositionsInflated(c,p[m-1]))continue;s+=\",\"}s+=B.encode(c.generatedColumn-e),e=c.generatedColumn,c.source!=null&&(_=this._sources.indexOf(c.source),s+=B.encode(_-l),l=_,s+=B.encode(c.originalLine-1-t),t=c.originalLine-1,s+=B.encode(c.originalColumn-n),n=c.originalColumn,c.name!=null&&(f=this._names.indexOf(c.name),s+=B.encode(f-i),i=f)),h+=s}return h};E.prototype._generateSourcesContent=function(e,r){return e.map(function(n){if(!this._sourcesContents)return null;r!=null&&(n=y.relative(r,n));var t=y.toSetString(n);return Object.prototype.hasOwnProperty.call(this._sourcesContents,t)?this._sourcesContents[t]:null},this)};E.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return this._file!=null&&(e.file=this._file),this._sourceRoot!=null&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e};E.prototype.toString=function(){return JSON.stringify(this.toJSON())};oe.SourceMapGenerator=E;var W={},fe={};(function(o){o.GREATEST_LOWER_BOUND=1,o.LEAST_UPPER_BOUND=2;function e(r,n,t,i,l,h){var s=Math.floor((n-r)/2)+r,c=l(t,i[s],!0);return c===0?s:c>0?n-s>1?e(s,n,t,i,l,h):h==o.LEAST_UPPER_BOUND?n<i.length?n:-1:s:s-r>1?e(r,s,t,i,l,h):h==o.LEAST_UPPER_BOUND?s:r<0?-1:r}o.search=function(n,t,i,l){if(t.length===0)return-1;var h=e(-1,t.length,n,t,i,l||o.GREATEST_LOWER_BOUND);if(h<0)return-1;for(;h-1>=0&&i(t[h],t[h-1],!0)===0;)--h;return h}})(fe);var he={};function J(o,e,r){var n=o[e];o[e]=o[r],o[r]=n}function ye(o,e){return Math.round(o+Math.random()*(e-o))}function Z(o,e,r,n){if(r<n){var t=ye(r,n),i=r-1;J(o,t,n);for(var l=o[n],h=r;h<n;h++)e(o[h],l)<=0&&(i+=1,J(o,i,h));J(o,i+1,h);var s=i+1;Z(o,e,r,s-1),Z(o,e,s+1,n)}}he.quickSort=function(o,e){Z(o,e,0,o.length-1)};var g=D,ne=fe,$=H.ArraySet,Ce=Q,F=he.quickSort;function S(o,e){var r=o;return typeof o==\"string\"&&(r=g.parseSourceMapInput(o)),r.sections!=null?new R(r,e):new L(r,e)}S.fromSourceMap=function(o,e){return L.fromSourceMap(o,e)};S.prototype._version=3;S.prototype.__generatedMappings=null;Object.defineProperty(S.prototype,\"_generatedMappings\",{configurable:!0,enumerable:!0,get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}});S.prototype.__originalMappings=null;Object.defineProperty(S.prototype,\"_originalMappings\",{configurable:!0,enumerable:!0,get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}});S.prototype._charIsMappingSeparator=function(e,r){var n=e.charAt(r);return n===\";\"||n===\",\"};S.prototype._parseMappings=function(e,r){throw new Error(\"Subclasses must implement _parseMappings\")};S.GENERATED_ORDER=1;S.ORIGINAL_ORDER=2;S.GREATEST_LOWER_BOUND=1;S.LEAST_UPPER_BOUND=2;S.prototype.eachMapping=function(e,r,n){var t=r||null,i=n||S.GENERATED_ORDER,l;switch(i){case S.GENERATED_ORDER:l=this._generatedMappings;break;case S.ORIGINAL_ORDER:l=this._originalMappings;break;default:throw new Error(\"Unknown order of iteration.\")}var h=this.sourceRoot;l.map(function(s){var c=s.source===null?null:this._sources.at(s.source);return c=g.computeSourceURL(h,c,this._sourceMapURL),{source:c,generatedLine:s.generatedLine,generatedColumn:s.generatedColumn,originalLine:s.originalLine,originalColumn:s.originalColumn,name:s.name===null?null:this._names.at(s.name)}},this).forEach(e,t)};S.prototype.allGeneratedPositionsFor=function(e){var r=g.getArg(e,\"line\"),n={source:g.getArg(e,\"source\"),originalLine:r,originalColumn:g.getArg(e,\"column\",0)};if(n.source=this._findSourceIndex(n.source),n.source<0)return[];var t=[],i=this._findMapping(n,this._originalMappings,\"originalLine\",\"originalColumn\",g.compareByOriginalPositions,ne.LEAST_UPPER_BOUND);if(i>=0){var l=this._originalMappings[i];if(e.column===void 0)for(var h=l.originalLine;l&&l.originalLine===h;)t.push({line:g.getArg(l,\"generatedLine\",null),column:g.getArg(l,\"generatedColumn\",null),lastColumn:g.getArg(l,\"lastGeneratedColumn\",null)}),l=this._originalMappings[++i];else for(var s=l.originalColumn;l&&l.originalLine===r&&l.originalColumn==s;)t.push({line:g.getArg(l,\"generatedLine\",null),column:g.getArg(l,\"generatedColumn\",null),lastColumn:g.getArg(l,\"lastGeneratedColumn\",null)}),l=this._originalMappings[++i]}return t};W.SourceMapConsumer=S;function L(o,e){var r=o;typeof o==\"string\"&&(r=g.parseSourceMapInput(o));var n=g.getArg(r,\"version\"),t=g.getArg(r,\"sources\"),i=g.getArg(r,\"names\",[]),l=g.getArg(r,\"sourceRoot\",null),h=g.getArg(r,\"sourcesContent\",null),s=g.getArg(r,\"mappings\"),c=g.getArg(r,\"file\",null);if(n!=this._version)throw new Error(\"Unsupported version: \"+n);l&&(l=g.normalize(l)),t=t.map(String).map(g.normalize).map(function(f){return l&&g.isAbsolute(l)&&g.isAbsolute(f)?g.relative(l,f):f}),this._names=$.fromArray(i.map(String),!0),this._sources=$.fromArray(t,!0),this._absoluteSources=this._sources.toArray().map(function(f){return g.computeSourceURL(l,f,e)}),this.sourceRoot=l,this.sourcesContent=h,this._mappings=s,this._sourceMapURL=e,this.file=c}L.prototype=Object.create(S.prototype);L.prototype.consumer=S;L.prototype._findSourceIndex=function(o){var e=o;if(this.sourceRoot!=null&&(e=g.relative(this.sourceRoot,e)),this._sources.has(e))return this._sources.indexOf(e);var r;for(r=0;r<this._absoluteSources.length;++r)if(this._absoluteSources[r]==o)return r;return-1};L.fromSourceMap=function(e,r){var n=Object.create(L.prototype),t=n._names=$.fromArray(e._names.toArray(),!0),i=n._sources=$.fromArray(e._sources.toArray(),!0);n.sourceRoot=e._sourceRoot,n.sourcesContent=e._generateSourcesContent(n._sources.toArray(),n.sourceRoot),n.file=e._file,n._sourceMapURL=r,n._absoluteSources=n._sources.toArray().map(function(m){return g.computeSourceURL(n.sourceRoot,m,r)});for(var l=e._mappings.toArray().slice(),h=n.__generatedMappings=[],s=n.__originalMappings=[],c=0,f=l.length;c<f;c++){var _=l[c],p=new ge;p.generatedLine=_.generatedLine,p.generatedColumn=_.generatedColumn,_.source&&(p.source=i.indexOf(_.source),p.originalLine=_.originalLine,p.originalColumn=_.originalColumn,_.name&&(p.name=t.indexOf(_.name)),s.push(p)),h.push(p)}return F(n.__originalMappings,g.compareByOriginalPositions),n};L.prototype._version=3;Object.defineProperty(L.prototype,\"sources\",{get:function(){return this._absoluteSources.slice()}});function ge(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}L.prototype._parseMappings=function(e,r){for(var n=1,t=0,i=0,l=0,h=0,s=0,c=e.length,f=0,_={},p={},m=[],w=[],M,b,C,N,U;f<c;)if(e.charAt(f)===\";\")n++,f++,t=0;else if(e.charAt(f)===\",\")f++;else{for(M=new ge,M.generatedLine=n,N=f;N<c&&!this._charIsMappingSeparator(e,N);N++);if(b=e.slice(f,N),C=_[b],C)f+=b.length;else{for(C=[];f<N;)Ce.decode(e,f,p),U=p.value,f=p.rest,C.push(U);if(C.length===2)throw new Error(\"Found a source, but no line and column\");if(C.length===3)throw new Error(\"Found a source and line, but no column\");_[b]=C}M.generatedColumn=t+C[0],t=M.generatedColumn,C.length>1&&(M.source=h+C[1],h+=C[1],M.originalLine=i+C[2],i=M.originalLine,M.originalLine+=1,M.originalColumn=l+C[3],l=M.originalColumn,C.length>4&&(M.name=s+C[4],s+=C[4])),w.push(M),typeof M.originalLine==\"number\"&&m.push(M)}F(w,g.compareByGeneratedPositionsDeflated),this.__generatedMappings=w,F(m,g.compareByOriginalPositions),this.__originalMappings=m};L.prototype._findMapping=function(e,r,n,t,i,l){if(e[n]<=0)throw new TypeError(\"Line must be greater than or equal to 1, got \"+e[n]);if(e[t]<0)throw new TypeError(\"Column must be greater than or equal to 0, got \"+e[t]);return ne.search(e,r,i,l)};L.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var r=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var n=this._generatedMappings[e+1];if(r.generatedLine===n.generatedLine){r.lastGeneratedColumn=n.generatedColumn-1;continue}}r.lastGeneratedColumn=1/0}};L.prototype.originalPositionFor=function(e){var r={generatedLine:g.getArg(e,\"line\"),generatedColumn:g.getArg(e,\"column\")},n=this._findMapping(r,this._generatedMappings,\"generatedLine\",\"generatedColumn\",g.compareByGeneratedPositionsDeflated,g.getArg(e,\"bias\",S.GREATEST_LOWER_BOUND));if(n>=0){var t=this._generatedMappings[n];if(t.generatedLine===r.generatedLine){var i=g.getArg(t,\"source\",null);i!==null&&(i=this._sources.at(i),i=g.computeSourceURL(this.sourceRoot,i,this._sourceMapURL));var l=g.getArg(t,\"name\",null);return l!==null&&(l=this._names.at(l)),{source:i,line:g.getArg(t,\"originalLine\",null),column:g.getArg(t,\"originalColumn\",null),name:l}}}return{source:null,line:null,column:null,name:null}};L.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return e==null}):!1};L.prototype.sourceContentFor=function(e,r){if(!this.sourcesContent)return null;var n=this._findSourceIndex(e);if(n>=0)return this.sourcesContent[n];var t=e;this.sourceRoot!=null&&(t=g.relative(this.sourceRoot,t));var i;if(this.sourceRoot!=null&&(i=g.urlParse(this.sourceRoot))){var l=t.replace(/^file:\\/\\//,\"\");if(i.scheme==\"file\"&&this._sources.has(l))return this.sourcesContent[this._sources.indexOf(l)];if((!i.path||i.path==\"/\")&&this._sources.has(\"/\"+t))return this.sourcesContent[this._sources.indexOf(\"/\"+t)]}if(r)return null;throw new Error('\"'+t+'\" is not in the SourceMap.')};L.prototype.generatedPositionFor=function(e){var r=g.getArg(e,\"source\");if(r=this._findSourceIndex(r),r<0)return{line:null,column:null,lastColumn:null};var n={source:r,originalLine:g.getArg(e,\"line\"),originalColumn:g.getArg(e,\"column\")},t=this._findMapping(n,this._originalMappings,\"originalLine\",\"originalColumn\",g.compareByOriginalPositions,g.getArg(e,\"bias\",S.GREATEST_LOWER_BOUND));if(t>=0){var i=this._originalMappings[t];if(i.source===n.source)return{line:g.getArg(i,\"generatedLine\",null),column:g.getArg(i,\"generatedColumn\",null),lastColumn:g.getArg(i,\"lastGeneratedColumn\",null)}}return{line:null,column:null,lastColumn:null}};W.BasicSourceMapConsumer=L;function R(o,e){var r=o;typeof o==\"string\"&&(r=g.parseSourceMapInput(o));var n=g.getArg(r,\"version\"),t=g.getArg(r,\"sections\");if(n!=this._version)throw new Error(\"Unsupported version: \"+n);this._sources=new $,this._names=new $;var i={line:-1,column:0};this._sections=t.map(function(l){if(l.url)throw new Error(\"Support for url field in sections not implemented.\");var h=g.getArg(l,\"offset\"),s=g.getArg(h,\"line\"),c=g.getArg(h,\"column\");if(s<i.line||s===i.line&&c<i.column)throw new Error(\"Section offsets must be ordered and non-overlapping.\");return i=h,{generatedOffset:{generatedLine:s+1,generatedColumn:c+1},consumer:new S(g.getArg(l,\"map\"),e)}})}R.prototype=Object.create(S.prototype);R.prototype.constructor=S;R.prototype._version=3;Object.defineProperty(R.prototype,\"sources\",{get:function(){for(var o=[],e=0;e<this._sections.length;e++)for(var r=0;r<this._sections[e].consumer.sources.length;r++)o.push(this._sections[e].consumer.sources[r]);return o}});R.prototype.originalPositionFor=function(e){var r={generatedLine:g.getArg(e,\"line\"),generatedColumn:g.getArg(e,\"column\")},n=ne.search(r,this._sections,function(i,l){var h=i.generatedLine-l.generatedOffset.generatedLine;return h||i.generatedColumn-l.generatedOffset.generatedColumn}),t=this._sections[n];return t?t.consumer.originalPositionFor({line:r.generatedLine-(t.generatedOffset.generatedLine-1),column:r.generatedColumn-(t.generatedOffset.generatedLine===r.generatedLine?t.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}};R.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})};R.prototype.sourceContentFor=function(e,r){for(var n=0;n<this._sections.length;n++){var t=this._sections[n],i=t.consumer.sourceContentFor(e,!0);if(i)return i}if(r)return null;throw new Error('\"'+e+'\" is not in the SourceMap.')};R.prototype.generatedPositionFor=function(e){for(var r=0;r<this._sections.length;r++){var n=this._sections[r];if(n.consumer._findSourceIndex(g.getArg(e,\"source\"))!==-1){var t=n.consumer.generatedPositionFor(e);if(t){var i={line:t.line+(n.generatedOffset.generatedLine-1),column:t.column+(n.generatedOffset.generatedLine===t.line?n.generatedOffset.generatedColumn-1:0)};return i}}}return{line:null,column:null}};R.prototype._parseMappings=function(e,r){this.__generatedMappings=[],this.__originalMappings=[];for(var n=0;n<this._sections.length;n++)for(var t=this._sections[n],i=t.consumer._generatedMappings,l=0;l<i.length;l++){var h=i[l],s=t.consumer._sources.at(h.source);s=g.computeSourceURL(t.consumer.sourceRoot,s,this._sourceMapURL),this._sources.add(s),s=this._sources.indexOf(s);var c=null;h.name&&(c=t.consumer._names.at(h.name),this._names.add(c),c=this._names.indexOf(c));var f={source:s,generatedLine:h.generatedLine+(t.generatedOffset.generatedLine-1),generatedColumn:h.generatedColumn+(t.generatedOffset.generatedLine===h.generatedLine?t.generatedOffset.generatedColumn-1:0),originalLine:h.originalLine,originalColumn:h.originalColumn,name:c};this.__generatedMappings.push(f),typeof f.originalLine==\"number\"&&this.__originalMappings.push(f)}F(this.__generatedMappings,g.compareByGeneratedPositionsDeflated),F(this.__originalMappings,g.compareByOriginalPositions)};W.IndexedSourceMapConsumer=R;var Le=oe.SourceMapGenerator,z=D,Me=/(\\r?\\n)/,we=10,j=\"$$$isSourceNode$$$\";function O(o,e,r,n,t){this.children=[],this.sourceContents={},this.line=o==null?null:o,this.column=e==null?null:e,this.source=r==null?null:r,this.name=t==null?null:t,this[j]=!0,n!=null&&this.add(n)}O.fromStringWithSourceMap=function(e,r,n){var t=new O,i=e.split(Me),l=0,h=function(){var p=w(),m=w()||\"\";return p+m;function w(){return l<i.length?i[l++]:void 0}},s=1,c=0,f=null;return r.eachMapping(function(p){if(f!==null)if(s<p.generatedLine)_(f,h()),s++,c=0;else{var m=i[l]||\"\",w=m.substr(0,p.generatedColumn-c);i[l]=m.substr(p.generatedColumn-c),c=p.generatedColumn,_(f,w),f=p;return}for(;s<p.generatedLine;)t.add(h()),s++;if(c<p.generatedColumn){var m=i[l]||\"\";t.add(m.substr(0,p.generatedColumn)),i[l]=m.substr(p.generatedColumn),c=p.generatedColumn}f=p},this),l<i.length&&(f&&_(f,h()),t.add(i.splice(l).join(\"\"))),r.sources.forEach(function(p){var m=r.sourceContentFor(p);m!=null&&(n!=null&&(p=z.join(n,p)),t.setSourceContent(p,m))}),t;function _(p,m){if(p===null||p.source===void 0)t.add(m);else{var w=n?z.join(n,p.source):p.source;t.add(new O(p.originalLine,p.originalColumn,w,m,p.name))}}};O.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(r){this.add(r)},this);else if(e[j]||typeof e==\"string\")e&&this.children.push(e);else throw new TypeError(\"Expected a SourceNode, string, or an array of SourceNodes and strings. Got \"+e);return this};O.prototype.prepend=function(e){if(Array.isArray(e))for(var r=e.length-1;r>=0;r--)this.prepend(e[r]);else if(e[j]||typeof e==\"string\")this.children.unshift(e);else throw new TypeError(\"Expected a SourceNode, string, or an array of SourceNodes and strings. Got \"+e);return this};O.prototype.walk=function(e){for(var r,n=0,t=this.children.length;n<t;n++)r=this.children[n],r[j]?r.walk(e):r!==\"\"&&e(r,{source:this.source,line:this.line,column:this.column,name:this.name})};O.prototype.join=function(e){var r,n,t=this.children.length;if(t>0){for(r=[],n=0;n<t-1;n++)r.push(this.children[n]),r.push(e);r.push(this.children[n]),this.children=r}return this};O.prototype.replaceRight=function(e,r){var n=this.children[this.children.length-1];return n[j]?n.replaceRight(e,r):typeof n==\"string\"?this.children[this.children.length-1]=n.replace(e,r):this.children.push(\"\".replace(e,r)),this};O.prototype.setSourceContent=function(e,r){this.sourceContents[z.toSetString(e)]=r};O.prototype.walkSourceContents=function(e){for(var r=0,n=this.children.length;r<n;r++)this.children[r][j]&&this.children[r].walkSourceContents(e);for(var t=Object.keys(this.sourceContents),r=0,n=t.length;r<n;r++)e(z.fromSetString(t[r]),this.sourceContents[t[r]])};O.prototype.toString=function(){var e=\"\";return this.walk(function(r){e+=r}),e};O.prototype.toStringWithSourceMap=function(e){var r={code:\"\",line:1,column:0},n=new Le(e),t=!1,i=null,l=null,h=null,s=null;return this.walk(function(c,f){r.code+=c,f.source!==null&&f.line!==null&&f.column!==null?((i!==f.source||l!==f.line||h!==f.column||s!==f.name)&&n.addMapping({source:f.source,original:{line:f.line,column:f.column},generated:{line:r.line,column:r.column},name:f.name}),i=f.source,l=f.line,h=f.column,s=f.name,t=!0):t&&(n.addMapping({generated:{line:r.line,column:r.column}}),i=null,t=!1);for(var _=0,p=c.length;_<p;_++)c.charCodeAt(_)===we?(r.line++,r.column=0,_+1===p?(i=null,t=!1):t&&n.addMapping({source:f.source,original:{line:f.line,column:f.column},generated:{line:r.line,column:r.column},name:f.name})):r.column++}),this.walkSourceContents(function(c,f){n.setSourceContent(c,f)}),{code:r.code,map:n}};var Ae=W.SourceMapConsumer;class K{static get consumer(){return this._consumer===void 0&&(this._consumer=new Ae(require(\"source-map\"))),this._consumer}static sourceMapStackTrace(e){const r=e instanceof Error?e.stack:e;if(Object.prototype.hasOwnProperty.call(this.cache,r))return this.cache[r];const[n,...t]=r.split(`\n    at `),i=[];for(let s=0;;s++){const c=t[s],f=c.slice(c.indexOf(\"(\")+1,c.indexOf(\")\")).split(\":\");if(f[0]!==\"loop\"){s&&(i[s-1].name=\"" + name + "\");break}const _=this.consumer.originalPositionFor({line:parseInt(f[1],10)-1,column:parseInt(f[2],10)});s&&(i[s-1].name=_.name),i.push(_)}const l=i.map(s=>`${s.name} (${s.source}:${s.line}:${s.column})`),h=[n,...l].join(`\n    at `);return this.cache[r]=h,h}static warpLoop(e){try{e()}catch(r){if(r instanceof Error)console.log(`<span style=\"color:red\">${\"sim\"in Game.rooms?`Source map don't work in the simulator - displaying oringinal error<br>${r.stack}`:this.sourceMapStackTrace(r)}</span>`);else throw r}}}q(K,\"_consumer\"),q(K,\"cache\",{});const Oe=K.warpLoop(require(\"loop\")." + name + ");exports.loop=Oe;\n"
const wrap = (name: string) => `"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("loop").${name};exports.loop=o;`;

export interface ScreepsConfig {
  token: string
  branch: string,
  protocol?: "http" | "https",
  hostname?: string,
  port?: number,
  path?: string,
  loopName?: string
}

export interface ScreepsOptions {
  configFile?: string
  config?: ScreepsConfig
  dryRun?: boolean
}

function getEntryNumber(options: NormalizedInputOptions) {
  if (options.input instanceof Array) {
    return options.input.length;
  } else {
    return Object.keys(options.input).length;
  }
}

function getLoopName(exports: string[]) {
  if (exports.length === 0) throw new Error("entry export nothing");
  if (exports.includes("loop")) return "loop";
  if (exports.includes("main")) return "main";
  return exports[0];
}

function log(str: string) {
  console.log(`[screeps]:\x1b[33m ${str}\x1b]`)
}

export function screeps(config: ScreepsConfig): PluginOption {
  return {
    name: "screeps",

    buildStart(options) {
      const entryNumber = getEntryNumber(options);
      if (entryNumber > 1) {
        throw new Error(`expected one entry, but found ${entryNumber}\n`)
      }
    },

    async writeBundle(options, bundle) {
      const code = new CodeAPI(config)

      const modules: CodeData['modules'] = {};
      const loop = Object.values(bundle).find(o => o.type === "chunk") as OutputChunk;
      const loopName = config.loopName ?? getLoopName(loop.exports);
      modules['loop'] = "\n" + loop.code;
      if (options.sourcemap == true) {
        delete (loop.map as any).sourcesContent
        modules['source-map'] = `module.exports=${loop.map!.toString()};`;
        modules['main'] = errorWrap(loopName);
      } else {
        modules['main'] = wrap(loopName);
      }

      const [data, message] = await code.upload(config.branch, modules)
        .then(({ data }) => [data, null])
        .catch(({ message }) => [null, message]);

      if (message) throw new Error(message)
      if (data.error) throw new Error(data.error)
      log(`uploaded at ${new Date(data.timestamp).toJSON()}`)
    }
  }
}

